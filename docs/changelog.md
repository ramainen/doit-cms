История версий
==============

2.1.5.1
------

Вывод ошибки при неудаче найти файл шаблона в новом классе view;

*19.11.2015*

2.1.5
-----

Рекурсивный итератор <tree> для шаблонизатора.

	<?php  d()->this = d()->Region->where('region_id is null') ;  ?>
	<select name="region_id">
		<option value="">-не указано-</option>
		<tree regions>
			<option value="{.id}">
				{level|times "—"} {this.title}
			</option>
		</tree>	
	</select>


*27.10.2015*

2.1.4
-----

Функция times для повтора символов и текста:

	<?php d()->level = 5; ?>
	{level|times "—"}

*26.10.2015*

2.1.3
-----

Базовая поддержка постпроцессора CSS. (autoprefixer, cssnano, и т.д.)

Синтаксис следующий:

	<head>
	{{stylesheets '/css/style.scss'}}
	</head>


Компиляция CSS проводится в облаке, соответственно, без подключённого Интернета не работает.	

*10.08.2015*



2.1.2
-----

Новый валидатор, поддержка bootstrap 3 в автоматической подсветке ошибок.

*10.08.2015*

2.1.1
-----

Запись {{/projects/_one.html}} для отображения партиала для версии 2.0

*06.08.2015*



2.1.0.beta
----------

Значительно переработан шаблонизатор.

Появились конструкции:

	@print 2+2;
	
	{* comment *}
	
	{user.product.source.parent.author|h|preview '200', 'auto'}

*07.07.2015*


2.0
---

Требование PHP 5.3.

Появление контейнера объектов. Появление Swift mailer. Появление cms/vendor/

*07.07.2015*

0.30
----

Ace Editor в редакторе ini файлов

0.29.9.1
--------

В папке sites теперь можно указывать не полное имя домена, а только поддомен.

*05.06.2015*

0.29.9
------

Кнопка "сохранить и добавить ещё" при добавлении объекта [демо](http://i.imgur.com/CPfBXrq.gif). Багфиксы.

*21.04.2015*

0.29.8
------

Файлы в загрузчике картинок и файлов, включая tinymce, теперь имеют человекопонятные имена.

*21.04.2015*


0.29.7.1
--------

Поддержка времени в датах, передаваемых в Date()

*09.09.2014*

0.29.7

Вставка картинок в TinyMCE через CTRL+V;

*09.09.2014*

0.29.6
------

Поддержка произвольных HTML в конфигах форм администратора.

Для вставки в fields/tablename.ini надо вписать код:

	include "mycontainer"

`mycontainer` - имя HTML файла, либо метод контроллера, либо функция. Например, допустимо:

	include "users#editform"

Для вставки классических элементов в подобные шаблоны можно использовать следующий синтаксис:

	{{form_row 'small', 'subtitle', 'Подзаголовок'}}

Может использоваться для вывода инструкций и другой информации прямо в формах администратора, а также для создания элементов управления повышенной сложности.
	
Поддержка третьего необязательного параметра для `container` в админке. Указывает на массив доступных модулей (ini) вместо `container.ini`.

*06.09.2014*

0.29.5.1
--------

Поддержка названий в контейнерах `container`. Меняется двойным щелчком.

*05.09.2014*

0.29.5
------

Поддержка нескольких получателей события через socket.io.

Используется так:

	d()->SocketIO->emit('bb156e7e617ad61894cbdf35481705a0' ,'server_event','Привет1');
	d()->SocketIO->emit('7a30bb1f473b2d6dc642c05d83adbb75' ,'server_event','Привет2');
	d()->SocketIO->emit(array('7a30bb1f473b2d6dc642c05d83adbb75','bb156e7e617ad61894cbdf35481705a0') ,'server_event','Привет 1 и 2');

В качестве удобства также теперь доступна конструкция `d()->Socketio->userid`, устанавливаемая по-умолчанию;
	
*02.09.2014*

0.29.4
------

Поддержка строк, массивов любой вложенности при передаче на сервер сообщений (socket.io). Облачный сервер прописан по-умолчанию (если не указывается иной адрес)

*29.08.2014*

0.29.3
------

Базовая поддержка Push запросов с сервера через прокси node.js.

*29.08.2014*

0.29.2
------

Новое правило автоподставления шаблонов теперь работает только с контроллером pages. С остальными контроллерами поведение старое. Соответственно обратной совместимости стало немного больше.

*25.08.2014*

0.29.1
------

Новая версия системы.

Значительные изменения в системе роутинга.

 1. Файл `router.init.ini` устарел. Все изменения вносятся в файл `router.func.php`. Для старых проектов можно ничего не делать - всё будет продолжать работать. Также можно удалить `router.func.php` и всё будет работать по-прежнему. Однако использование правил роутера в виде функций даёт ряд преимуществ: более лаконичный синтаксис, возможность ставить условия, циклы, анонимные функции, поддержка роутеров для ленивых, а в дальнейшем дополнительные фильтры на типы запросов. Пока этот файл удалять не стоит - скаффолдинг использует именного его. Однако сейчас при наличии функции `route_all`в файле `router.func.php` галочку "добавить запись в роутер" при использовании скаффолдинга можно не делать.
 2. В файле `router.func.php` и любых других можно указывать команды `route()`, которые добавляют правила роутинга. При этом слово `content` можно игнорировать.
 3. В файле `router.func.php` по-умолчанию запускается функция `route_all()`, которая автоматически добавляет правило роутить контроллеры автоматически, например, `/news/` на `news#`. Таким образом, **теперь класс `NewsController` будет доступен по адресу `/news/` полностью автоматически**. Это не будет активировано для старых проектов (т.к. функция `route_all()` не запущена. Это правило отменяется для любых адресов, для которых зарегистрировано хотя бы одно правило в роутере.
 4. При определении шаблона метода контроллера проверяется наличие файла. Если мы запрашиваем страницу `/users/vasya` методом `show()` и файл `_vasya.html` существует, то именно он будет использоваться в качестве шаблона. **Это может поменять поведение в некоторых случаях!** Пример такого случая: для роутинга на `/index` не создавалось правил вообще, использовался `classname#` (например, `users#` или `news#`), при этом метода `index` не создавалось (и зря). Использовался шаблон `_index.html` без вызова метода контроллера. Теперь же метод `show()` контроллера будет вызван.
 Эта новая возможность делает работу немного легче. Например, чтобы переопределить шаблон главной страницы, достаточно создать файл `_index.html` и всё.
 5. Теперь необъявленный класс вида `Blabalbacontroller` (заканчивающийся на `controller`) не будет создан автоматически (как `ActiveRecord`) при обращении к нему.
 6. Функция `route` может принять на вход анонимную функцию. Это позволяет использовать систему как микрофреймворк, но в данном случае версия PHP должна быть уже 5.3 или выше (5.2 не поддерживает анонимные функции).

*25.08.2014*


0.29
----

Новый роутер.

*24.08.2014*


0.28.2.1
--------

Исправлен баг: `delete` не очищал кеш ActiveRecord;

*21.08.2014*

0.28.2
------

Поддержка ватермарков (водяных знаков) в функции `preview`. Используется параметр `watermark`, указывающий на картинку.

Использовать так:
	
	<img src="{.image|preview 'watermark'=>'/images/header_watermark.png', 512,320}" alt="{.title|h}">
	
Или так:

	{{preview d()->this->image, '200', '300', 'watermark'=>'/images/watermark.png'}}

Картинка-watermark помещается по центру. Рекомендуется использовать для картинки-накладки тот же самый размер, что и генерируемая превью.
	
*15.08.2014*

0.28.1.3
--------

`UniversalSingletoneHelper` стал немного универсальнее. Минорное изменение.

*06.06.2014*

0.28.1.2
--------

Поддержка записи вида `{variable|function 'param'}`.

*06.06.2014*

0.28.1.1
--------

Исправлен баг: не генерировались `paginator_left` и `paginator_right` на bootstrap режиме пагинатора.

*06.06.2014*

0.28
----

Поддержка контейнеров. Контейнер позволяет вставить на страницу множество различных элементов, таких как заголовки, столбцы, картинки, формы. Может использоваться для создания посадочных страниц и богатого оформления заранее заготовленными блоками. Для использования необходимо:

**Первое.** Создать функцию, которая может быть контейнером. Например, `contactform#show`, а также другие функции.

**Второе.** Создать файл `container.ini` со следующим содержимым (перечислить функции):

	[container]
	contactform#show=Форма обратной связи
	contactform#show1=Первый модуль
	contactform#show2=Второй модуль
	news#index=Список новостей

**Третье.** В файле `/fields/pages.ini` или другом, соответствующем нужной таблице написать строчку:

	container text2 "Элементы управления"

Перетащить туда несколько элементов.

**Четвёртое.** В шаблоне написать `{.text2|container}`.

Всё. Элемент управления, ini-файл, функция-обработчик - все они называются **`container`**. Если привязать контейнер к опциям, можно делать сквозные элементы (которые повторяются по всему сайту).

Внутри кода контейнера доступна переменная `d()->plugin_id` с уникальным строковым идентификатором, указывающим на конкретный компонент внутри контейнера.

*11.05.2014*

0.27.2.2
------

Класс Mail теперь принимает свойство from даже в том случае, если не используется SMTP (вариант отправки через `mail()` без вложенных файлов).

Использовать, например, так:
	
	d()->Mail->from('Робот сайта <noreply@example.com>');

*07.05.2014*

0.27.2.1
------

Исправление AJAX части формы для IE8.

*04.04.2014*

0.27.2
------

Полиморфные объекты для `linked`. Изменения довольно важные и полезные, поэтому будут описаны в отдельном документе. Теперь можно делать похожие товары, аксессуары, друзья, и так далее.

*04.04.2014*

0.27.1.2
--------

Введён новый метод `ActiveRecord->ne`, возвращает true, если есть хотя бы один результат.

*02.04.2014*


0.27.1.1
--------

Введён новый метод `ActiveRecord->is_not_empty`, возвращает true, если есть хотя бы один результат.

*02.04.2014*

0.27.1
------

### Новый метод `plus`

Поддержка метода `plus`. Позволяет добавить к массиву ещё один. Не переопределяет текущий объект, а **создаёт новый**.

Например:

	d()->goods = d()->Good->where('cost < 100');
	d()->goods = d()->goods->plus(12);//12 - ID товара

	//Также умеет принимать массив товаров
	d()->goods = d()->goods->plus(d()->Good->where('cost > 1000'));

Принимает число, массив чисел, массив ассоциативных массивов с полем `id`, объект ActiveRecord.

### Новый метод `all_linked` или `_all_catalogs`

Подержка метода `all_linked`. Делает `linked` рекурсивно, пока получается. Не столь явно и универсально, как `linked`, но зато позволяет получить всё дерево в глубину. Имеет псевдоним `_all_*`, например, `_all_catalogs`.

	d()->Catalog(3)->_all_catalogs; //Все дочерние каталоги и их дочерние каталоги и т.д. 

Пример получения всех товаров каталога c ID=$id и всех его дочерних каталогов. С постраничной навигацией.

	d()->catalog = d()->Catalog($id);
	d()->catalog = d()->catalog->_all_catalogs;
	d()->catalog->plus($id);
	d()->goods = d()->catalog->_goods->paginate(2);

Тоже самое одной строкой:
	
	d()->goods = d()->Catalog($id)->_all_catalogs->plus($id)->_goods->paginate(2);

Допустим, товары дополнительно хранятся в `catalogs_to_goods` через альтернативную связь `many_to_many`.

	
	/*
		Данный код получает все каталоги, подкаталоги,
		под-под-каталоги и т.д. каталог с id=$id, 
		затем получает все товары всех этих каталогов,
		в том числе и указанных напрямую через catalog_id,
		и через дополнительную связь many_to_many,
		а также товаров самого каталога $id.
		Полученные товары подвергаются пагинации.
	*/
	d()->goods = d()->Catalog($id)
		->_all_catalogs
		->plus($id)
		->_goods
		->plus(d()->Catalog($id)->_all_catalogs->_catalogs_to_goods->_goods)
		->paginate(2);

Конечно, вот так вот "однострочничать" не рекомендуется.

*01.04.2014*


0.27
----

Значительное обновление в ActiveRecord. Появление метода `linked`, который получает связанные объекты. Для массива каталогов `linked('goods')` вернёт массив товаров в этих каталогах, для массива товаров `linked('catalogs')` вернёт массив каталогов этих товаров.

Если товар или каталог один - ничего страшного.

Массивы являются объектами ActiveRecord, поэтому к ним можно применять `where`, `limit`, `paginate` и так далее.

Более удобная сокращённая запись: `d()->Good->_catalogs` (аналог `d()->Good->linked('catalogs')`). Предположительно, станет основным инструментом получения данных (обычный способ останется для совместимости).

	d()->Catalog(13)->catalogs->_goods; // Вернёт все товары всех подкаталогов каталога 13
	d()->Catalog(13)->catalogs->_goods->_users; // Вернёт всех пользователей всех товаров каталога 13
	
	// Вернёт все каталоги, в которых есть товары с ценой меньше 100, с постраничной навигацией
	d()->Good->where('cost < 100')->_catalogs->paginate(10);
	
	//Пользователи, которые оставляли комментарии за последний день
	d()->Comment->where('created_at > ?',d()->Date('yesterday')->to_mysql)->_users;

Рассмотрим более сложный случай:

*  У нас есть таблица `works` с портфолио.
*  Есть таблица `portfoliodirections` с тегами для портфолио (направления работы). Одна работа может иметь несколько направлений.
*  Есть таблица `portfoliodirections_to_works`, у которой есть столбцы `portfoliodirection_id` и `work_id`.

Итого: `many_to_many` таблица связей.

Мы хотим получить список всех работ по тегу с ID=3, а также всех работ по тегам, ID которых больше 2

Решение:
	
	d()->Portfoliodirection(3)->_portfoliodirections_to_works->_works;
	d()->Portfoliodirection->where('id > 2')->_portfoliodirections_to_works->_works;

Кроме того, добавлен метод ActiveRecord для более быстрого получения `all_of('ids')`.

Вызывается так:

	d()->Catalog->fast_all_of('id');

Склонять во множественном числе не надо, объекты не создаются, данные берутся напрямую из массива. В некоторых случаях такой вызов на 2-3 порядка быстрее обычного. В любом случае в дальнейшем метод `linked` должен привести к тому, что `all_of` просто не пригодится.

Кроме того, оптимизирован `where('id IN (?)',$array)`, который теперь делает `array_unique`, что на пару процентов ускоряет запрос.

*31.03.2014*

0.26.12
---------

Отныне `d()->Page('')` ничего не вернёт (количество записей будет равно нулю).

*27.03.2014*

0.26.11.1
---------

Поддержка записей вида `d()->Page('index')`. Ищет по `url`, является синтаксическим сахаром. Будет использоваться в модуле "меню".

*27.03.2014*

0.26.11
-------

В роутере теперь проще писать алиасы для html-шаблонов - `.html` автоматически меняется на `_tpl`. Например, теперь можно писать так:

	/index		main.html		index.html

*27.03.2014*

0.26.10
-------

Поддержка метода `where_equal` в ActiveRecord. Первый аттрибут - название поля, второе - значение. Например:

	d()->news_list = d()->News->where_equal('title', 12);

Может пригодиться в том случае, когда названия столбцов передаются через переменные. Всё экранирование происходит автоматически.

*25.03.2014*

0.26.9
------

Параметр в валидаторе для отображения скрытого поля. Если поле пришло не пустым - валидатор дальше не пустит. Необходимо для защиты от ботов. В валидаторе пишется следующее:

	[validator.contactform#send.city]
	must_be_empty.message=Возможно, вы робот. Уйдите.

В код формы вставляется примерно следующее:
	
	
	<div style="display:none">
		<input  type="text" name="city" placeholder="Город" autocomplete="off">
	</div>

autocomplete="off" необходимо, чтобы в это поле не вбился автоматически город. Поле `city` можно изменить на любое подходящее.

**Внимание!** название поля в виде `city`, а не `data[city]` актуально только для форм с `'simple_names'=>true,`! Это обычное поле с обычными данными и обычным валидатором, просто работает наоборот.
	
*24.03.2014*

0.26.8.1
--------

{{sort_icon}} без параметров берёт опции предыдущего {{add}}. Это сделано потому, что в большинстве случаях (срого говоря, на практике - во всех) параметры этих иконок всегда одинаковы.

*23.03.2013*

0.26.8
------

Теперь администратор может сортировать столбики в таблице вывода списка элементов путём щелчка по ним.

*22.03.2014*

0.26.7
------

Поддержка записи вида

	d()->News(array(12,5,7));
	//Идентично следующему
	d()->News->where('id IN (?)', array(12,5,7));

*21.03.2014*

0.26.6.1
--------

Поддержка TRUNCATE в ActiveRecord. Вызывается так:

	d()->Konkurs->truncate(true);
	d()->Page->truncate(true);

true - обязательный параметр, его не надо настраивать или передавать как переменную. Это сделано для безопасности.

**Внимание!** Выполнение функции как переменной или вызов без обязательного параметра `true` приведёт к ошибке. Будьте внимательны и осторожны со своими данными.

*19.03.2014*

0.26.6
------

Функция `declOfNum` (определяющая множественное число) теперь имеет несколько альтернативных синтаксисов:

	//Было
	d()->declOfNum(81,array('попугай','попугая','попугаев'))
	//Теперь ещё можно так
	d()->declOfNum(1,'комментарий','комментария','комментариев');
	d()->declOfNum(2,'комментарий','комментария','комментариев');

Также теперь можно вовсе не передавать все слова - функция сама попытается определить грамматически правильную форму:

	d()->declOfNum(2,'комментарий'); //комментария
	d()->declOfNum(20,'новость'); //новостей

Это также работает для английских слов (на всякий случай):
	
	d()->declOfNum(20,'child'); //children

Также шаблонизатор поддерживает конструкцию вида `{obj.prop|func "params"}`. В итоге, теперь можно писать так:

	{news_list.count} {news_list.count|declOfNum "новость"}
	{Comment.count} {Comment.count|declOfNum "комментарий"}

Также обновлены тесты для всего этого.

*18.03.2014*

0.26.5
------

Обновлён TinyMCE 3.5.6 (2012-07-26) → 3.5.10 (2013-10-24).

*17.03.2014*

0.26.4
------

Поддержка татарского языка в датах (мультиязычность). Поддержка обработок дат вида

	d()->Date('12 января 2014');
	d()->Date('12 гыйнвар 2014');
	d()->Date('12 02 2014');


*16.03.2014*


0.26.3
------
`htmlimage` загрузчик картинок теперь поддерживает перетаскивание нескольких файлов одновременно (для `multiple=yes`).

Модуль `image` теперь полностью замещён новым загрузчиком. Для старых браузеров автоматически отображается старый вариант на flash.

Таким образом, сейчас основной элемент `image` для загрузок картинок администратором обновлён, выглядит и работает по другому. Сам механизм и принцип работы остались прежними, в первую очередь добавились удобства - скорость работы, работа на некоторых устройствах без flash (некоторые планшеты и т.д.), появилось перетаскивание файлов в браузер, вставка из буфера обмена, внешний вид.

*13.03.2014*

0.26.2.3
--------

`htmlimage` загрузчик картинок теперь поддерживает `multiple=yes`, позволяя выбрать несколько изображений одновременно.

*13.03.2014*

0.26.2.2
--------

`htmlimage` загрузчик картинок теперь может вставлять изображения перетаскиванием файла в браузер.

*12.03.2014*

0.26.2.1
--------

`htmlimage` загрузчик картинок теперь может вставлять изображения из буфера обмена (изображения, не файлы изображений) и автоматически загружать их в виде файлов.

*12.03.2014*

0.26.2
------
Поддержка автогенерируемого sitemap.xml.

В роутере необходимо прописать

	/sitemap.xml	main		show_sitemap

Файлы `sitemap.func.php` и `sitemap.ini` должны находиться в папке app (они не создадутся при обновлении). Сами правила описаны в файле `sitemap.ini`, там перечислены адреса и таблицы, которые должны быть видны в карте сайта.

0.26.1.1
--------

Исправлено поведение загрузчика в IE11.

*11.03.2014*

0.26.1
------
Новый тип файлового загрузчика для панели администратора, без использования flash. Вызывается тем же синтаксисом, но называется `htmlimage`:

	htmlimage image "Изображение" galleries 180 auto

Работает немного отзывчивее, чем на основе flash, но работает только начиная с IE9 и Opera 12. ([http://caniuse.com/xhr2](http://caniuse.com/xhr2)).

Если опыт покажет положительный результат, обычный `image` будет заменён на этот, либо в старых браузерах будет подставляться flash-версия.

*11.03.2014*

0.26
----
Поддержка пользователей для системы администрирования с правами на разные таблицы.

Для того, чтобы воспользоваться, следует раскомментировать строки в `admin.ini` (или вписать их):

	[admin.users]
	enabled=yes

И добавить ссылку на редактирование пользователей.

	[admin.leftmenu]
	admin_users "Администраторы системы"

Система предложить создать таблицу `admin_users`. Для создания нового пользователя системы администрирования необходимо указать его логин, пароль и список таблиц, в которые он имеет доступ через запятую, например, `pages, news, options`.

Все иконки администратора будут автоматически скрываться, если у администратора нет соответствующего доступа.

Доступ закрывается к таблицам, включая иконки, страницы редактирования и списка объектов, а
также на сами действия по сохранению, созданию или удалению.

Более подробно будет описано в документации.

*11.03.2014*

0.25.3
------
Поддержка нормальных дат.

Наконец появилась возможность задавать даты в админке в поле формата `date`, а не строки.

Итого, для использования в админке необходимо вписать:

	date date_at "Дата"

Если будет передана пустая строка, то дата сохранится как `NULL`, тоже самое касается класса `ActiveRecord` в целом.

**Внимание!** Если вы манипулировали в своих проектах строками вида "0000-00-00 00:00:00", то теперь вместо них будет записываться `NULL`

Обязательное условие - название поля должно оканчиваться на `_at`, например, `date_at`, `fired_at`, `posted_at`.

Функция `userdate`, преобразующая к нормальному виду, по-прежнему работает.

Появилась возможность написать

	<?php
	d()->Date(d()->this->posted_at)->to_simple(); // "24.03.2014"
	d()->Date(d()->this->posted_at)->to_mysql(); // "2014-03-24 12:00:00"

Также обновлены тесты для пагинации и для проверки дат.

*10.03.2014*

0.25.2
------
Класс `Upload` для простой загрузки файлов  изображений.

Для самого простого использования:
	
	$filename = d()->Upload->save();

В переменной `$filename` будет находиться адрес к файлу (в случае картинки - готовой к созданию превью). По-умолчанию пустит только картинки и распространённые файлы.

Параметр `upload` для формы, указывающий `enctype` для загрузки файлов.

*09.03.2014*

0.25.1.1
--------
Вывод текущей версии в админке (только для developer, подвал и страница обновления).

*08.03.2014*

0.25.1
------
Оптимизирован код ActiveRecord, убраны некоторые лишние проверки, которые никогда не будут вызваны.

Заведена история версий, которая будет использоваться для определения текущей версии системы (для обновления).

*08.03.2014*
